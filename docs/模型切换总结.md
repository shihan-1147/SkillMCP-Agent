# æ¨¡å‹åˆ‡æ¢æ€»ç»“

## âœ… å®Œæˆå†…å®¹

### 1. ä¿®æ”¹é…ç½®
- **æ–‡ä»¶**: `.env`
- **ä¿®æ”¹**: `OLLAMA_MODEL=gemini-3-flash-preview:latest` â†’ `OLLAMA_MODEL=qwen3:latest`

### 2. é›†æˆ Ollama å®¢æˆ·ç«¯
- **æ–‡ä»¶**: `src/api/chat_service.py`
- **ä¿®æ”¹**: 
  - æ·»åŠ å¯¼å…¥: `from src.core.ollama import get_ollama_client`
  - é‡å†™ `_handle_general()` æ–¹æ³•ï¼Œä½¿ç”¨ Ollama LLM è¿›è¡Œæ™ºèƒ½å¯¹è¯

### 3. æ ¸å¿ƒä»£ç å˜æ›´

#### åŸå®ç°ï¼ˆç¡¬ç¼–ç å›å¤ï¼‰
```python
async def _handle_general(self, message: str, history: List[Dict[str, str]]) -> str:
    """å¤„ç†é€šç”¨å¯¹è¯"""
    # ç®€å•çš„è§„åˆ™å›å¤
    greetings = ["ä½ å¥½", "æ‚¨å¥½", "hi", "hello", "å—¨"]
    if any(g in message.lower() for g in greetings):
        return "ä½ å¥½ï¼æˆ‘æ˜¯æ™ºèƒ½åŠ©æ‰‹..."
    
    # é»˜è®¤å›å¤
    return "æˆ‘ç†è§£ä½ çš„é—®é¢˜äº†..."
```

#### æ–°å®ç°ï¼ˆLLM æ™ºèƒ½å›å¤ï¼‰
```python
async def _handle_general(self, message: str, history: List[Dict[str, str]]) -> str:
    """å¤„ç†é€šç”¨å¯¹è¯ - ä½¿ç”¨ Ollama LLM è¿›è¡Œæ™ºèƒ½å›å¤"""
    try:
        # è·å– Ollama å®¢æˆ·ç«¯
        client = get_ollama_client()
        
        # æ„å»ºæ¶ˆæ¯å†å²
        messages = []
        messages.append({
            "role": "system",
            "content": "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·æŸ¥è¯¢å¤©æ°”ã€ç«è½¦ç¥¨ä¿¡æ¯ï¼Œæˆ–è€…å›ç­”å„ç§é—®é¢˜..."
        })
        
        # æ·»åŠ å†å²å¯¹è¯ï¼ˆæœ€å¤š 10 è½®ï¼‰
        for msg in history[-10:]:
            messages.append({
                "role": msg["role"],
                "content": msg["content"]
            })
        
        # æ·»åŠ å½“å‰æ¶ˆæ¯
        messages.append({
            "role": "user",
            "content": message
        })
        
        # è°ƒç”¨ Ollama
        response = await client.chat(
            messages=messages,
            temperature=0.7,
            max_tokens=2048
        )
        
        # è¿”å›å›å¤
        if response and response.get("success") and response.get("content"):
            return response["content"]
        else:
            return "æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚"
            
    except Exception as e:
        logger.error(f"Ollama chat error: {e}", exc_info=True)
        return "æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›æŠ€æœ¯é—®é¢˜..."
```

## ğŸ¯ æµ‹è¯•ç»“æœ

### æµ‹è¯•ç”¨ä¾‹
1. **é—®å€™**: "ä½ å¥½"
   - âœ… å›å¤: "ä½ å¥½ï¼æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ"

2. **èº«ä»½è¯¢é—®**: "ä½ æ˜¯è°ï¼Ÿ"
   - âœ… å›å¤: "ä½ å¥½ï¼æˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œä¸€ä¸ªç”±é€šä¹‰å®éªŒå®¤å¼€å‘çš„è¶…å¤§è§„æ¨¡è¯­è¨€æ¨¡å‹..."

3. **å¤©æ°”æŸ¥è¯¢**: "åŒ—äº¬æ˜å¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"
   - âœ… è¿”å›çœŸå®å¤©æ°”æ•°æ®ï¼ˆé«˜å¾·åœ°å›¾ APIï¼‰
   - âœ… ç»“æ„åŒ–æ•°æ®åŒ…å«æ¸©åº¦ã€æ¹¿åº¦ã€é£åŠ›ç­‰

4. **ç«è½¦ç¥¨æŸ¥è¯¢**: "å¸®æˆ‘æŸ¥è¯¢æ˜å¤©ä»åŒ—äº¬åˆ°ä¸Šæµ·çš„é«˜é“ç¥¨"
   - âœ… è¿”å›çœŸå®ç«è½¦ç¥¨æ•°æ®ï¼ˆ12306 MCPï¼‰
   - âœ… æ˜¾ç¤º 10 ä¸ªè½¦æ¬¡çš„è¯¦ç»†ä¿¡æ¯

5. **æ„Ÿè°¢**: "è°¢è°¢"
   - âœ… å›å¤: "ä¸å®¢æ°”ï¼ğŸ˜Š å¦‚æœä½ éœ€è¦å¸®åŠ©é¢„è®¢è½¦ç¥¨æˆ–è·å–æ›´å¤šå‡ºè¡Œå»ºè®®ï¼Œéšæ—¶å‘Šè¯‰æˆ‘å“¦~"

## ğŸ“Š åŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| é€šç”¨å¯¹è¯ | ç¡¬ç¼–ç è§„åˆ™å›å¤ | qwen3:latest æ™ºèƒ½å›å¤ |
| ä¸Šä¸‹æ–‡ç†è§£ | âŒ æ—  | âœ… æ”¯æŒå¤šè½®å¯¹è¯ï¼ˆæœ€å¤š 10 è½®ï¼‰ |
| å›å¤è´¨é‡ | æœºæ¢°ã€é‡å¤ | è‡ªç„¶ã€ä¸ªæ€§åŒ– |
| å¤©æ°”æŸ¥è¯¢ | âœ… çœŸå®æ•°æ® | âœ… çœŸå®æ•°æ® |
| ç«è½¦ç¥¨æŸ¥è¯¢ | âœ… çœŸå®æ•°æ® | âœ… çœŸå®æ•°æ® |

## ğŸ”§ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯è¯·æ±‚    â”‚
â”‚  (Vue 3)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI è·¯ç”±                â”‚
â”‚  POST /api/v1/chat           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ChatService                 â”‚
â”‚  - æ„å›¾è¯†åˆ«                   â”‚
â”‚  - è·¯ç”±åˆ†å‘                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       v         v            v          v
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ é€šç”¨å¯¹è¯ â”‚ â”‚ å¤©æ°”   â”‚ â”‚ ç«è½¦ç¥¨ â”‚ â”‚ çŸ¥è¯†åº“   â”‚
  â”‚ (Ollama)â”‚ â”‚ (é«˜å¾·) â”‚ â”‚ (MCP)  â”‚ â”‚ (RAG)    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       v
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Ollama API           â”‚
  â”‚ http://localhost:11434â”‚
  â”‚ Model: qwen3:latest  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. ç¡®ä¿æœåŠ¡è¿è¡Œ
```bash
# æ£€æŸ¥ Ollama æœåŠ¡
ollama list

# åº”è¯¥çœ‹åˆ°:
# qwen3:latest                  xxx MB

# å¯åŠ¨ Ollamaï¼ˆå¦‚æœæœªè¿è¡Œï¼‰
ollama serve
```

### 2. å¯åŠ¨åç«¯
```bash
cd e:\SkillMCP-Agent
python -m uvicorn src.api.app:app --host 127.0.0.1 --port 8000 --reload
```

### 3. æµ‹è¯•å¯¹è¯
```bash
# é€šè¿‡æµ‹è¯•è„šæœ¬
python tests/test_api_chat.py

# æˆ–é€šè¿‡å‰ç«¯
# è®¿é—® http://localhost:3000
```

### 4. API è°ƒç”¨ç¤ºä¾‹
```python
import requests

response = requests.post(
    "http://127.0.0.1:8000/api/v1/chat",
    json={
        "message": "ä½ å¥½ï¼Œå¸®æˆ‘æŸ¥è¯¢åŒ—äº¬å¤©æ°”",
        "session_id": "user123"
    }
)

print(response.json()["reply"])
```

## ğŸ“ å­¦ä¹ è¦ç‚¹

1. **Ollama é›†æˆ**: ä½¿ç”¨å®˜æ–¹ Ollama HTTP API è¿›è¡Œæ¨¡å‹è°ƒç”¨
2. **ä¸Šä¸‹æ–‡ç®¡ç†**: ä¿ç•™æœ€è¿‘ 10 è½®å¯¹è¯å†å²ï¼Œæå‡å¯¹è¯è¿è´¯æ€§
3. **ç³»ç»Ÿæç¤º**: é€šè¿‡ system prompt å®šä¹‰åŠ©æ‰‹è§’è‰²å’Œèƒ½åŠ›
4. **é”™è¯¯å¤„ç†**: ä¼˜é›…å¤„ç†æ¨¡å‹è°ƒç”¨å¤±è´¥ï¼Œè¿”å›å‹å¥½æç¤º
5. **å“åº”æ ¼å¼**: ç»Ÿä¸€ä½¿ç”¨ `{"success": bool, "content": str}` æ ¼å¼

## ğŸ” è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹ Ollama æ—¥å¿—
```bash
# åœ¨ Ollama æœåŠ¡çª—å£æŸ¥çœ‹è¯·æ±‚æ—¥å¿—
# ä¼šæ˜¾ç¤ºæ¯æ¬¡ API è°ƒç”¨çš„è¯¦ç»†ä¿¡æ¯
```

### æŸ¥çœ‹åç«¯æ—¥å¿—
```bash
# åç«¯å¯åŠ¨çª—å£ä¼šæ˜¾ç¤º:
# - INFO: Calling Ollama model: qwen3:latest
# - INFO: Ollama response: xxx...
```

### æµ‹è¯•å•ä¸ªå¯¹è¯
```python
from src.core.ollama import get_ollama_client
import asyncio

async def test():
    client = get_ollama_client()
    response = await client.chat(
        messages=[
            {"role": "user", "content": "ä½ å¥½"}
        ]
    )
    print(response["content"])

asyncio.run(test())
```

## âœ¨ ä¸‹ä¸€æ­¥ä¼˜åŒ–å»ºè®®

1. **æµå¼è¾“å‡º**: å®ç° `/api/v1/chat/stream` ç«¯ç‚¹ï¼Œæ”¯æŒå®æ—¶è¾“å‡º
2. **ç¼“å­˜**: å¯¹å¸¸è§é—®é¢˜æ·»åŠ ç¼“å­˜æœºåˆ¶
3. **è¯„åˆ†**: è®°å½•ç”¨æˆ·å¯¹å›å¤çš„è¯„åˆ†ï¼Œä¼˜åŒ–æç¤ºè¯
4. **å¤šæ¨¡å‹**: æ”¯æŒåˆ‡æ¢ä¸åŒæ¨¡å‹ï¼ˆå¦‚ deepseek-r1ï¼‰
5. **å·¥å…·è°ƒç”¨**: åˆ©ç”¨ Ollama çš„ Tool Calling èƒ½åŠ›è‡ªåŠ¨è°ƒç”¨ MCP å·¥å…·

## ğŸ“Œ æ³¨æ„äº‹é¡¹

- âœ… ç¡®ä¿ Ollama æœåŠ¡åœ¨ `http://localhost:11434` è¿è¡Œ
- âœ… ç¡®ä¿ `qwen3:latest` æ¨¡å‹å·²ä¸‹è½½
- âœ… é…ç½®æ–‡ä»¶ `.env` ä¸­çš„ `OLLAMA_MODEL` è¦ä¸å®é™…æ¨¡å‹åä¸€è‡´
- âœ… åç«¯éœ€è¦é‡å¯æ‰èƒ½åŠ è½½æ–°ä»£ç ï¼ˆæˆ–ä½¿ç”¨ `--reload` æ¨¡å¼ï¼‰
- âœ… å‰ç«¯æ— éœ€ä¿®æ”¹ï¼Œç»§ç»­è°ƒç”¨ `/api/v1/chat` å³å¯

---

**æ—¥æœŸ**: 2026-01-19  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶æµ‹è¯•é€šè¿‡
